"""
================================================================================
DHA Dataset Analysis and Visualization Script
================================================================================

PURPOSE:
    Analyze the synthetic DHA datasets generated by generate_dha_datasets.py
    and create visualizations for data quality and analytics exercises.

PYTHON VERSION REQUIRED:
    Python 3.12

DEPENDENCY INSTALLATION:
    pip install pandas matplotlib seaborn openpyxl

HOW TO RUN THE SCRIPT:
    python analyze_dha_datasets.py

INPUT:
    Reads CSV files from the /data directory:
    - population_registry.csv
    - dha_applications.csv

OUTPUT:
    Generates analysis reports and visualizations:
    - Analysis results printed to console
    - Chart images saved to /output directory

================================================================================
"""

import pandas as pd
import matplotlib.pyplot as plt
import seaborn as sns
import os
from datetime import datetime

# Set style for better-looking plots
sns.set_style("whitegrid")
plt.rcParams['figure.figsize'] = (12, 6)
plt.rcParams['font.size'] = 10

# Create output directory for charts
OUTPUT_DIR = 'output'
os.makedirs(OUTPUT_DIR, exist_ok=True)

# Data directory
DATA_DIR = 'data'


def load_datasets():
    """
    Load the population registry and applications datasets.
    
    Returns:
        Tuple of (population_df, applications_df)
    """
    population_path = os.path.join(DATA_DIR, 'population_registry.csv')
    applications_path = os.path.join(DATA_DIR, 'dha_applications.csv')
    
    if not os.path.exists(population_path):
        raise FileNotFoundError(f"Population registry file not found: {population_path}")
    if not os.path.exists(applications_path):
        raise FileNotFoundError(f"Applications file not found: {applications_path}")
    
    print("Loading datasets...")
    population_df = pd.read_csv(population_path)
    applications_df = pd.read_csv(applications_path)
    
    # Convert date columns to datetime
    population_df['date_of_birth'] = pd.to_datetime(population_df['date_of_birth'])
    population_df['record_created_date'] = pd.to_datetime(population_df['record_created_date'])
    applications_df['application_date'] = pd.to_datetime(applications_df['application_date'])
    applications_df['last_updated_date'] = pd.to_datetime(applications_df['last_updated_date'])
    
    print(f"‚úì Loaded {len(population_df):,} population records")
    print(f"‚úì Loaded {len(applications_df):,} application records\n")
    
    return population_df, applications_df


def analyze_population_registry(population_df: pd.DataFrame):
    """
    Analyze population registry data and create visualizations.
    
    Args:
        population_df: Population registry DataFrame
    """
    print("="*70)
    print("POPULATION REGISTRY ANALYSIS")
    print("="*70)
    
    # 1. Total Number of Population
    total_population = len(population_df)
    print(f"\n1. Total Number of Population: {total_population:,}")
    
    # 2. Total Unique number of population (by SA ID)
    unique_population = population_df['sa_id_number'].nunique()
    print(f"2. Total Unique Population (by SA ID): {unique_population:,}")
    duplicates = total_population - unique_population
    print(f"   ‚Üí Duplicate SA IDs found: {duplicates:,}")
    
    # 3. Gender distribution
    gender_counts = population_df['gender'].value_counts()
    print(f"\n3. Gender Distribution:")
    for gender, count in gender_counts.items():
        percentage = (count / total_population) * 100
        print(f"   {gender}: {count:,} ({percentage:.2f}%)")
    
    # Plot gender distribution
    plt.figure(figsize=(8, 6))
    colors = ['#3498db', '#e74c3c']
    gender_counts.plot(kind='bar', color=colors[:len(gender_counts)])
    plt.title('Population Registry: Gender Distribution', fontsize=14, fontweight='bold')
    plt.xlabel('Gender', fontsize=12)
    plt.ylabel('Number of People', fontsize=12)
    plt.xticks(rotation=0)
    plt.grid(axis='y', alpha=0.3)
    
    # Add value labels on bars
    for i, (gender, count) in enumerate(gender_counts.items()):
        plt.text(i, count + total_population * 0.01, f'{count:,}', 
                ha='center', va='bottom', fontweight='bold')
    
    plt.tight_layout()
    plt.savefig(os.path.join(OUTPUT_DIR, 'population_gender_distribution.png'), dpi=300)
    print(f"   ‚úì Saved chart: output/population_gender_distribution.png")
    plt.close()
    
    # 4. Born after 1975
    born_after_1975 = population_df[population_df['date_of_birth'].dt.year > 1975]
    count_after_1975 = len(born_after_1975)
    percentage_after_1975 = (count_after_1975 / total_population) * 100
    print(f"\n4. Born After 1975:")
    print(f"   Count: {count_after_1975:,} ({percentage_after_1975:.2f}% of total)")
    print(f"   Born 1975 or earlier: {total_population - count_after_1975:,}")
    
    # Plot birth year distribution
    population_df['birth_year'] = population_df['date_of_birth'].dt.year
    plt.figure(figsize=(14, 6))
    
    # Histogram of birth years
    plt.hist(population_df['birth_year'], bins=50, color='#2ecc71', edgecolor='black', alpha=0.7)
    plt.axvline(x=1975, color='red', linestyle='--', linewidth=2, label='1975 (Cutoff)')
    plt.title('Population Registry: Birth Year Distribution', fontsize=14, fontweight='bold')
    plt.xlabel('Birth Year', fontsize=12)
    plt.ylabel('Number of People', fontsize=12)
    plt.legend()
    plt.grid(axis='y', alpha=0.3)
    plt.tight_layout()
    plt.savefig(os.path.join(OUTPUT_DIR, 'population_birth_year_distribution.png'), dpi=300)
    print(f"   ‚úì Saved chart: output/population_birth_year_distribution.png")
    plt.close()
    
    print("\n" + "-"*70)


def analyze_applications(applications_df: pd.DataFrame):
    """
    Analyze DHA applications data and create visualizations.
    
    Args:
        applications_df: Applications DataFrame
    """
    print("\n" + "="*70)
    print("DHA APPLICATIONS ANALYSIS")
    print("="*70)
    
    total_applications = len(applications_df)
    
    # 1. Total number of applications by province
    province_counts = applications_df['province'].value_counts().sort_values(ascending=False)
    print(f"\n1. Total Number of Applications by Province:")
    for province, count in province_counts.items():
        percentage = (count / total_applications) * 100
        print(f"   {province}: {count:,} ({percentage:.2f}%)")
    
    # Plot applications by province
    plt.figure(figsize=(14, 8))
    colors = sns.color_palette("husl", len(province_counts))
    province_counts.plot(kind='barh', color=colors)
    plt.title('DHA Applications: Total by Province', fontsize=14, fontweight='bold')
    plt.xlabel('Number of Applications', fontsize=12)
    plt.ylabel('Province', fontsize=12)
    plt.grid(axis='x', alpha=0.3)
    
    # Add value labels
    for i, (province, count) in enumerate(province_counts.items()):
        plt.text(count + total_applications * 0.01, i, f'{count:,}', 
                va='center', fontweight='bold')
    
    plt.tight_layout()
    plt.savefig(os.path.join(OUTPUT_DIR, 'applications_by_province.png'), dpi=300)
    print(f"   ‚úì Saved chart: output/applications_by_province.png")
    plt.close()
    
    # 2. Application status distribution (with "Unknown" for None)
    applications_df['status_display'] = applications_df['application_status'].fillna('Unknown')
    status_counts = applications_df['status_display'].value_counts()
    print(f"\n2. Application Status Distribution:")
    for status, count in status_counts.items():
        percentage = (count / total_applications) * 100
        print(f"   {status}: {count:,} ({percentage:.2f}%)")
    
    # Plot application status
    plt.figure(figsize=(10, 6))
    colors = sns.color_palette("Set2", len(status_counts))
    status_counts.plot(kind='bar', color=colors)
    plt.title('DHA Applications: Status Distribution', fontsize=14, fontweight='bold')
    plt.xlabel('Application Status', fontsize=12)
    plt.ylabel('Number of Applications', fontsize=12)
    plt.xticks(rotation=45, ha='right')
    plt.grid(axis='y', alpha=0.3)
    
    # Add value labels
    for i, (status, count) in enumerate(status_counts.items()):
        plt.text(i, count + total_applications * 0.01, f'{count:,}', 
                ha='center', va='bottom', fontweight='bold', rotation=0)
    
    plt.tight_layout()
    plt.savefig(os.path.join(OUTPUT_DIR, 'applications_by_status.png'), dpi=300)
    print(f"   ‚úì Saved chart: output/applications_by_status.png")
    plt.close()
    
    # 3. Breakdown by branch
    branch_counts = applications_df['dha_branch_name'].value_counts().head(15)  # Top 15 branches
    print(f"\n3. Top 15 Branches by Application Volume:")
    for branch, count in branch_counts.items():
        percentage = (count / total_applications) * 100
        print(f"   {branch}: {count:,} ({percentage:.2f}%)")
    
    # Plot branch breakdown
    plt.figure(figsize=(14, 8))
    colors = sns.color_palette("viridis", len(branch_counts))
    branch_counts.plot(kind='barh', color=colors)
    plt.title('DHA Applications: Top 15 Branches', fontsize=14, fontweight='bold')
    plt.xlabel('Number of Applications', fontsize=12)
    plt.ylabel('DHA Branch', fontsize=12)
    plt.grid(axis='x', alpha=0.3)
    
    # Add value labels
    for i, (branch, count) in enumerate(branch_counts.items()):
        plt.text(count + total_applications * 0.01, i, f'{count:,}', 
                va='center', fontweight='bold')
    
    plt.tight_layout()
    plt.savefig(os.path.join(OUTPUT_DIR, 'applications_by_branch.png'), dpi=300)
    print(f"   ‚úì Saved chart: output/applications_by_branch.png")
    plt.close()
    
    # 4. Cost breakdown
    # ID Card: R350, Passport: R650
    applications_df['cost'] = applications_df['application_type'].apply(
        lambda x: 350 if x == 'ID Card' else 650
    )
    
    cost_by_type = applications_df.groupby('application_type')['cost'].agg(['sum', 'count'])
    total_revenue = applications_df['cost'].sum()
    
    print(f"\n4. Cost Breakdown:")
    print(f"   ID Card Applications: {cost_by_type.loc['ID Card', 'count']:,} √ó R350 = R{cost_by_type.loc['ID Card', 'sum']:,.2f}")
    print(f"   Passport Applications: {cost_by_type.loc['Passport', 'count']:,} √ó R650 = R{cost_by_type.loc['Passport', 'sum']:,.2f}")
    print(f"   Total Revenue: R{total_revenue:,.2f}")
    
    # Plot cost breakdown
    fig, (ax1, ax2) = plt.subplots(1, 2, figsize=(14, 6))
    
    # Pie chart for revenue by type
    revenue_by_type = applications_df.groupby('application_type')['cost'].sum()
    colors_pie = ['#3498db', '#e74c3c']
    ax1.pie(revenue_by_type.values, labels=revenue_by_type.index, autopct='%1.1f%%',
            colors=colors_pie, startangle=90, textprops={'fontsize': 12, 'fontweight': 'bold'})
    ax1.set_title('Revenue by Application Type', fontsize=14, fontweight='bold')
    
    # Bar chart for counts and revenue
    x = range(len(cost_by_type))
    width = 0.35
    ax2_twin = ax2.twinx()
    
    bars1 = ax2.bar([i - width/2 for i in x], cost_by_type['count'], width, 
                    label='Number of Applications', color='#3498db', alpha=0.7)
    bars2 = ax2_twin.bar([i + width/2 for i in x], cost_by_type['sum'], width,
                         label='Revenue (ZAR)', color='#e74c3c', alpha=0.7)
    
    ax2.set_xlabel('Application Type', fontsize=12)
    ax2.set_ylabel('Number of Applications', fontsize=12, color='#3498db')
    ax2_twin.set_ylabel('Revenue (ZAR)', fontsize=12, color='#e74c3c')
    ax2.set_xticks(x)
    ax2.set_xticklabels(cost_by_type.index)
    ax2.set_title('Applications and Revenue by Type', fontsize=14, fontweight='bold')
    ax2.grid(axis='y', alpha=0.3)
    
    # Add value labels
    for bar in bars1:
        height = bar.get_height()
        ax2.text(bar.get_x() + bar.get_width()/2., height,
                f'{int(height):,}', ha='center', va='bottom', fontweight='bold')
    
    for bar in bars2:
        height = bar.get_height()
        ax2_twin.text(bar.get_x() + bar.get_width()/2., height,
                     f'R{int(height):,}', ha='center', va='bottom', fontweight='bold', color='#e74c3c')
    
    ax2.legend(loc='upper left')
    ax2_twin.legend(loc='upper right')
    
    plt.tight_layout()
    plt.savefig(os.path.join(OUTPUT_DIR, 'applications_cost_breakdown.png'), dpi=300)
    print(f"   ‚úì Saved chart: output/applications_cost_breakdown.png")
    plt.close()
    
    # 5. Duplicate entries
    # Find duplicate SA ID numbers (same person, multiple applications)
    duplicate_sa_ids = applications_df[applications_df.duplicated(subset=['sa_id_number'], keep=False)]
    duplicate_count = len(duplicate_sa_ids)
    unique_duplicate_ids = duplicate_sa_ids['sa_id_number'].nunique()
    
    print(f"\n5. Duplicate Entries:")
    print(f"   Total duplicate application records: {duplicate_count:,}")
    print(f"   Unique SA IDs with duplicates: {unique_duplicate_ids:,}")
    
    if duplicate_count > 0:
        # Show top 10 SA IDs with most applications
        top_duplicates = duplicate_sa_ids['sa_id_number'].value_counts().head(10)
        print(f"\n   Top 10 SA IDs with Most Applications:")
        for sa_id, count in top_duplicates.items():
            print(f"   {sa_id}: {count} applications")
        
        # Plot duplicate distribution
        plt.figure(figsize=(12, 6))
        duplicate_dist = duplicate_sa_ids['sa_id_number'].value_counts().value_counts().sort_index()
        duplicate_dist.plot(kind='bar', color='#e67e22')
        plt.title('Distribution of Duplicate Applications\n(Number of Applications per SA ID)', 
                 fontsize=14, fontweight='bold')
        plt.xlabel('Number of Applications', fontsize=12)
        plt.ylabel('Number of SA IDs', fontsize=12)
        plt.xticks(rotation=0)
        plt.grid(axis='y', alpha=0.3)
        
        # Add value labels
        for i, (apps, sa_ids) in enumerate(duplicate_dist.items()):
            plt.text(i, sa_ids + max(duplicate_dist) * 0.01, f'{sa_ids:,}', 
                    ha='center', va='bottom', fontweight='bold')
        
        plt.tight_layout()
        plt.savefig(os.path.join(OUTPUT_DIR, 'applications_duplicates.png'), dpi=300)
        print(f"   ‚úì Saved chart: output/applications_duplicates.png")
        plt.close()
    else:
        print("   No duplicate entries found.")
    
    print("\n" + "-"*70)


def generate_summary_report(population_df: pd.DataFrame, applications_df: pd.DataFrame):
    """
    Generate a summary report of key statistics.
    
    Args:
        population_df: Population registry DataFrame
        applications_df: Applications DataFrame
    """
    print("\n" + "="*70)
    print("SUMMARY REPORT")
    print("="*70)
    
    # Population summary
    print(f"\nüìä POPULATION REGISTRY:")
    print(f"   Total Records: {len(population_df):,}")
    print(f"   Unique SA IDs: {population_df['sa_id_number'].nunique():,}")
    print(f"   Gender Split: {population_df['gender'].value_counts().to_dict()}")
    print(f"   Provinces: {population_df['province'].nunique()}")
    print(f"   Born after 1975: {len(population_df[population_df['date_of_birth'].dt.year > 1975]):,}")
    
    # Applications summary
    print(f"\nüìã DHA APPLICATIONS:")
    print(f"   Total Applications: {len(applications_df):,}")
    print(f"   Application Types: {applications_df['application_type'].value_counts().to_dict()}")
    print(f"   Status Distribution: {applications_df['application_status'].fillna('Unknown').value_counts().to_dict()}")
    print(f"   Total Revenue: R{applications_df['cost'].sum():,.2f}")
    print(f"   Duplicate Applications: {len(applications_df[applications_df.duplicated(subset=['sa_id_number'], keep=False)]):,}")
    
    # Data quality issues detected
    print(f"\n‚ö†Ô∏è  DATA QUALITY ISSUES DETECTED:")
    pop_duplicates = len(population_df) - population_df['sa_id_number'].nunique()
    pop_missing = population_df[['street_address', 'cell_number', 'postal_code', 'city']].isnull().sum().sum()
    app_duplicates = len(applications_df[applications_df.duplicated(subset=['sa_id_number'], keep=False)])
    app_missing_status = applications_df['application_status'].isnull().sum()
    
    print(f"   Population - Duplicate SA IDs: {pop_duplicates:,}")
    print(f"   Population - Missing Values: {pop_missing:,}")
    print(f"   Applications - Duplicate Entries: {app_duplicates:,}")
    print(f"   Applications - Missing Status: {app_missing_status:,}")
    
    print("\n" + "="*70)
    print("‚úì Analysis complete! All charts saved to 'output' directory.")
    print("="*70 + "\n")


def main():
    """
    Main function to run the analysis.
    """
    print("="*70)
    print("DHA DATASET ANALYSIS AND VISUALIZATION")
    print("Department of Home Affairs - South Africa")
    print("="*70)
    
    try:
        # Load datasets
        population_df, applications_df = load_datasets()
        
        # Analyze population registry
        analyze_population_registry(population_df)
        
        # Analyze applications
        analyze_applications(applications_df)
        
        # Generate summary report
        generate_summary_report(population_df, applications_df)
        
    except FileNotFoundError as e:
        print(f"\n‚ùå Error: {e}")
        print("Please run generate_dha_datasets.py first to create the data files.")
    except Exception as e:
        print(f"\n‚ùå Error: {e}")
        import traceback
        traceback.print_exc()


if __name__ == "__main__":
    main()

